name: "CI/CD ‚Äî deploy to VPS (PM2)"

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build (Next.js)
        run: npm run build

      - name: Prepare artifact
        run: |
          mkdir -p deploy
          # On copie tout sauf .git et node_modules (on r√©installe l√†-bas pour √™tre propre)
          cp -r .next package.json package-lock.json next.config.* public deploy/ 2>/dev/null || true
          # Si vous avez un dossier 'public' ou d'autres fichiers config, assurez-vous qu'ils sont copi√©s

      - name: Deploy via rsync/ssh
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          set -euo pipefail

          # Configuration SSH temporaire pour l'action
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts

          # D√©finition des dossiers (Dossier utilisateur = pas besoin de sudo)
          TS="$(date -u +%Y%m%dT%H%M%SZ)"
          # On cr√©e un dossier 'deployments' s√©par√© de 'apps' pour g√©rer les versions
          REMOTE_BASE="/home/abdou-deploy/deployments"
          REMOTE_RELEASE="$REMOTE_BASE/releases/$TS"

          echo "üìÇ Creating remote release dir..."
          ssh -i ~/.ssh/deploy_key abdou-deploy@$VPS_HOST "mkdir -p $REMOTE_RELEASE"

          echo "‚è´ Uploading files via rsync..."
          rsync -az --delete -e "ssh -i ~/.ssh/deploy_key" deploy/ abdou-deploy@$VPS_HOST:$REMOTE_RELEASE/

          echo "üîÅ Switching symlink & Reloading PM2..."
          ssh -i ~/.ssh/deploy_key abdou-deploy@$VPS_HOST "
            set -e
            
            # 1. Aller dans le nouveau dossier et installer les d√©pendances de prod
            cd $REMOTE_RELEASE
            npm ci --omit=dev

            # 2. Cr√©er/Mettre √† jour le lien symbolique 'current'
            # Cela permet de pointer '~/deployments/current' vers la nouvelle version
            ln -sfn $REMOTE_RELEASE $REMOTE_BASE/current
            
            # 3. Copier le fichier .env (qui doit rester sur le serveur pour s√©curit√©)
            # On suppose que vous avez mis le .env dans ~/apps/my_new_portfolio/.env
            # On le copie vers la nouvelle version pour qu'elle ait les secrets
            cp /home/abdou-deploy/apps/my_new_portfolio/.env $REMOTE_RELEASE/.env || true

            # 4. Red√©marrer PM2
            # La premi√®re fois, cela peut ne rien faire si PM2 pointe encore sur l'ancien dossier
            # Mais la commande reload met √† jour sans coupure
            pm2 reload portfolio --update-env || pm2 start npm --name 'portfolio' -- start
            
            # 5. Sauvegarder l'√©tat PM2
            pm2 save
            
            # Nettoyage : garder seulement les 5 derni√®res versions pour ne pas remplir le disque
            cd $REMOTE_BASE/releases
            ls -dt * | tail -n +6 | xargs -r rm -rf
          "

          echo "‚úÖ Deploy done"
